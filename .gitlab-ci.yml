# GitLab CI/CD Pipeline –¥–ª—è ACL Audit

stages:
  - build
  - release

variables:
  NODE_VERSION: "18"

# –ö—ç—à –¥–ª—è node_modules
cache:
  paths:
    - node_modules/

# –°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - apt-get update -qq && apt-get install -y -qq zip
    - npm install
  script:
    - node build-package.js
    - |
      VERSION=$(node -p "require('./manifest.json').version")
      ZIP_FILE="ACL-Audit-v${VERSION}-PRODUCTION.zip"
      if [ -f "$ZIP_FILE" ]; then
        SIZE=$(du -h "$ZIP_FILE" | cut -f1)
        echo "‚úÖ ZIP —Å–æ–∑–¥–∞–Ω: $ZIP_FILE ($SIZE)"
      else
        echo "‚ùå ZIP —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
      fi
  artifacts:
    paths:
      - ACL-Audit-v*-PRODUCTION.zip
    expire_in: 1 week
  only:
    - tags
    - main
    - master

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl
  script:
    - |
      VERSION=$(node -p "require('./manifest.json').version")
      ZIP_FILE="ACL-Audit-v${VERSION}-PRODUCTION.zip"
      
      # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ —á–µ—Ä–µ–∑ GitLab API
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
        --form "name=Release v${VERSION}" \
        --form "tag_name=v${VERSION}" \
        --form "description=## ACL Audit v${VERSION}
      
      –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –¥–ª—è Chrome Web Store.
      
      ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
      1. –°–∫–∞—á–∞–π—Ç–µ ZIP —Ñ–∞–π–ª –Ω–∏–∂–µ
      2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
      3. –û—Ç–∫—Ä–æ–π—Ç–µ \`chrome://extensions/\`
      4. –í–∫–ª—é—á–∏—Ç–µ \"–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞\"
      5. –ù–∞–∂–º–∏—Ç–µ \"–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ\"
      6. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
      
      ### üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è
      –°–º. CHANGELOG –¥–ª—è –¥–µ—Ç–∞–ª–µ–π." \
        --form "assets[links][][name]=Extension Package" \
        --form "assets[links][][url]=${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/${ZIP_FILE}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
  only:
    - tags
  dependencies:
    - build
