name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–µ–≥–∏ –≤–∏–¥–∞ v6.5.12
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Extract version from manifest
      id: get_version
      run: |
        $version = (Get-Content manifest.json | ConvertFrom-Json).version
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "Version extracted: $version"
        
    - name: Build package
      run: node build-package.js
      
    - name: Verify ZIP exists
      run: |
        $zipFile = "ACL-Audit-v$env:VERSION-PRODUCTION.zip"
        if (Test-Path $zipFile) {
          $size = (Get-Item $zipFile).Length / 1MB
          Write-Host "‚úÖ ZIP —Å–æ–∑–¥–∞–Ω: $zipFile ($([math]::Round($size, 2)) MB)"
        } else {
          Write-Host "‚ùå ZIP —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        }
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ACL-Audit-v*-PRODUCTION.zip
        name: Release ${{ env.VERSION }}
        body: |
          ## ACL Audit v${{ env.VERSION }}
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç –¥–ª—è Chrome Web Store.
          
          ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ ZIP —Ñ–∞–π–ª –Ω–∏–∂–µ
          2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
          3. –û—Ç–∫—Ä–æ–π—Ç–µ `chrome://extensions/`
          4. –í–∫–ª—é—á–∏—Ç–µ "–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞"
          5. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ"
          6. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
          
          ### üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è
          –°–º. [CHANGELOG](CHANGELOG-v${{ env.VERSION }}.md) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
